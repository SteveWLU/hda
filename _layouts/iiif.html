---
---

{% capture the_collection %}{{page.collection}}{% endcapture %}
  {% if page.collection %}
    {% assign documents = site[the_collection] %}
  {% endif %}
{% for link in documents  %}
  {% if link.title == page.title %}
    {% unless forloop.first %}
      {% assign prevurl = prev.url %}
      {% assign prevtitle = prev.title %}
    {% endunless %}
    {% unless forloop.last %}
      {% assign next = documents[forloop.index] %}
      {% assign nexturl = next.url %}
      {% assign nexttitle = next.title %}
    {% endunless %}
  {% endif %}
  {% assign prev = link %}
{% endfor %}

<div class="prevnext">
{% if prevurl %}Previous: <a href="{{site.baseurl}}{{prevurl}}" class="prev">{{prevtitle}}</a>{% endif %}<br />

{% if nexturl %}Next: <a href="{{site.baseurl}}{{nexturl}}" class="next">{{nexttitle}}</a>{% endif %}
</div>

<article class="post">

  <header class="post-header">
    <h1 class="post-title">{{ page.title }}</h1>
  </header>

  <div class="post-content">
	{% iiif %}
	{{ content }}
  </div>
  <div id="TEI" data-milestone="{{ page.milestone }}"></div>

  <style>
    tei-milestone {
      display: block;
      width: 100%;
      text-align: left;
      color: orangered;
      margin: 2em 0 2em 0;
      font-size: 11pt;
    }

    tei-milestone:before {
      content: "" attr(unit) attr(n) "";
    }

    tei-teiHeader {
      display: none;
    }

    .hid_page {
      display: none;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    li {
      margin-right: 20px;
      height: 50px;
      line-height: 50px;
      display: inline-block;
    }
  </style>

  <script src="https://teic.github.io/CETEIcean/js/CETEI.js"></script>
  <script>
  // CODE TO HIDE A PAGE
  function showPage(page) {
    // Hide all text that does not belong to the page indicated
    var n
    var pbs = 0
    var hide = false

    // First, remove all hiding CSS classes, if present.
    Array.from(document.querySelectorAll('.hid_page')).map(function (el) {
      el.classList.remove('hid_page')
    })

    // Walk trough all descendants of tei-text
    var walk = document.createTreeWalker(document.querySelector('tei-text'), NodeFilter.SHOW_ALL, null, false)
    while (n = walk.nextNode()) {
      if (n.nodeType === Node.ELEMENT_NODE) {
        //  If this is a page beginning, update page count.
        //  If page count is lower or higher than the page requested, set 'hide' flag.
        //  If page count corresponds to the page requested, remove 'hide' flag.
        if (n.localName === 'tei-milestone' ) {
          pbs++
          if (pbs != page) {
            hide = true
          } else {
            hide = false
          }
        }

        // If the hide flag is set and this is an empty element, hide it just in case the
        // CETEIcean CSS (or other) does something with it.
        if (hide && n.childNodes.length === 0) {
          n.classList.add('hid_page')
        }
      } else if (n.nodeType === Node.TEXT_NODE) {
        // We mostly operate at text node level by storing and restoring text data.

        // Start by always restoring text data is previously removed.
        if (n.storedContent) {
          n.textContent = n.storedContent
        }

        // If the 'hide' flag is set, store text content and remove it.
        if (hide) {
          n.storedContent = n.textContent
          n.textContent = ''
        }
      }
    }
  }
  // CODE TO RUN CETEICEAN
  var CETEIcean = new CETEI()
  CETEIcean.getHTML5("{{site.baseurl}}/editions/p.xml", function(data) {
    document.getElementById("TEI").innerHTML = ""
    document.getElementById("TEI").appendChild(data)
    CETEIcean.addStyle(document, data)

    //get current page
    const currentMilestone = document.getElementById("TEI").getAttribute("data-milestone");
    //show current page
    showPage(currentMilestone)
  });
</script>
</article>
